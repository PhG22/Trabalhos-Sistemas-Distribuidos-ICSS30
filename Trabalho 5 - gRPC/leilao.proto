syntax = "proto3";

package leilao;

// --- Mensagens de Dados ---

// Representa os dados completos de um leilão.
message LeilaoData {
    int32 id = 1;
    string descricao = 2;
    float valor_inicial = 3;
    string inicio = 4; // Formato ISO string
    string fim = 5;    // Formato ISO string
    string status = 6; // "pendente", "ativo", "encerrado"
    float valor_atual = 7;
}

// Dados necessários para efetuar um lance.
message LanceData {
    int32 leilao_id = 1;
    string user_id = 2;
    float valor = 3;
}

// Resposta padrão para tentativas de lance.
message LanceResponse {
    string status = 1;  // "ok" ou "erro"
    string message = 2; // Detalhe do erro ou sucesso
}

// Dados para iniciar um processo de pagamento.
message PaymentData {
    int32 leilao_id = 1;
    string vencedor_id = 2;
    float valor = 3;
}

// Mensagem genérica para eventos em tempo real (SSE).
// Substitui o JSON livre que antes trafegava no RabbitMQ.
message Evento {
    string tipo = 1; // "leilao_iniciado", "lance_validado"
    string payload_json = 2; // Conteúdo do evento serializado em JSON
}

message Empty {}

// --- Definição dos Serviços (Interfaces gRPC) ---

service AuctionService {
    // Cria um leilão e retorna seus dados.
    rpc CriarLeilao (LeilaoData) returns (LeilaoData);
    
    // Retorna um fluxo (stream) de leilões ativos (Server Streaming).
    rpc GetLeiloesAtivos (Empty) returns (stream LeilaoData);
    
    // Mantém um canal aberto enviando eventos do MS Leilão para o Gateway.
    rpc SubscribeEventos (Empty) returns (stream Evento);
}

service LanceService {
    // Processa um lance síncrono.
    rpc ProcessarLance (LanceData) returns (LanceResponse);
    
    // Retorna o estado atual dos lances para a listagem inicial.
    rpc GetLancesAtuais (Empty) returns (stream LeilaoData);
    
    // --- Comunicação Inter-serviços ---
    
    // O MS Leilão chama estes métodos para avisar o MS Lance sobre mudanças de estado.
    rpc NotificarInicioLeilao (LeilaoData) returns (Empty);
    rpc NotificarFimLeilao (LeilaoData) returns (Empty);
    
    // Canal de eventos para o Gateway (lances validados/inválidos).
    rpc SubscribeEventos (Empty) returns (stream Evento);
}

service PaymentService {
    // Chamado diretamente pelo MS Lance quando um vencedor é determinado.
    rpc ProcessarPagamento (PaymentData) returns (Empty);
    
    // Canal de eventos para o Gateway (link de pagamento, status).
    rpc SubscribeEventos (Empty) returns (stream Evento);
}